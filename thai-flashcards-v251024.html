<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>à¸¡à¸²à¸à¸­à¸”à¸¡à¸²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .font-sarabun { font-family: 'Sarabun', sans-serif; }
    .font-noto-thai { font-family: 'Noto Sans Thai', sans-serif; }
    .card-scene { perspective: 1000px; }
    .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
    .card.is-flipped { transform: rotateY(180deg); }
    .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .card-face-back { transform: rotateY(180deg); }
    .kbd { border: 1px solid rgb(75,85,99); border-bottom-width: 2px; padding: 0 0.4rem; border-radius: 0.375rem; font-size: 1em; }
      /* ===== æ·±ç¶ è‰²ä¸»é¡Œï¼šPantone 19-5513 TCXï¼ˆDark Greenï¼‰ =====
       ä¾†æºåå…­é€²ä½æ¨ä¼°ï¼š#314F40ï¼ˆä»¥ç¬¬ä¸‰æ–¹è‰²ç¢¼åº«èˆ‡è‰²ç¥¨é å°ç…§ï¼‰
       åƒè€ƒï¼šPantone å®˜æ–¹è‰²å¡é ï¼ˆåç¨±èˆ‡ç·¨è™Ÿï¼‰ã€icolorpalette / colorxs å°æ‡‰åå…­é€²ä½å€¼ã€‚
       æ³¨æ„ï¼šä¸‹åˆ—ç°éšé¡åˆ¥è¢«é‡æ–°æ˜ å°„ç‚ºæ·±ç¶ è‰²éšï¼Œé¿å…å…¨é¢æ”¹ classã€‚ */
    :root{
      /* å…¨ç«™æ·±ç¶ ä¸»é¡Œï¼šæ•´é«”å†èª¿æš—ä¸€éšï¼Œç¶­æŒé©åº¦å±¤æ¬¡ */
      --pantone-dark-green: #011a14; /* æœ€æ·±ï¼šé é¢èƒŒæ™¯ï¼ˆæ›´æš—ï¼‰ */
      --pantone-dark-green-900: #102c25; /* å€å¡ŠèƒŒæ™¯ */
      --pantone-dark-green-800: #17362e; /* å¡ç‰‡/æŒ‰éˆ•åŸºæº– */
      --pantone-dark-green-700: #21463b; /* æ¬¡æ·º */
      --pantone-dark-green-600: #2b5445; /* æ·º */
      --pantone-dark-green-500: #356151; /* æœ€æ·º */

      /* æ–‡å­—ç•¥é™äº®åº¦ï¼Œé¿å…èˆ‡åº•è‰²åå·®éå¤§ */
      --pantone-ink: #dbe8e2;       /* ä¸»è¦æ–‡å­— */
      --pantone-ink-muted: #b8c6c1; /* æ¬¡è¦æ–‡å­— */

      --pantone-border: #1c2c24;    /* é‚Šæ¡†é™°å½± */
      --pantone-dark-green-950: #01110d; /* æ·±æ§ä»¶å‚™ç”¨éšï¼ˆæ›´æ·±ï¼‰ */
    }
    /* é‡æ˜ å°„ Tailwind ç°éšåˆ°ç¶ éšï¼ˆé›†ä¸­è¦†è“‹ï¼‰ */
    body.bg-gray-900{ background-color: var(--pantone-dark-green) !important; color: var(--pantone-ink); }
    .bg-gray-900{ background-color: var(--pantone-dark-green-900) !important; }
    .bg-gray-800{ background-color: var(--pantone-dark-green-800) !important; }
    .bg-gray-700{ background-color: var(--pantone-dark-green-700) !important; }
    .bg-gray-600{ background-color: var(--pantone-dark-green-600) !important; }
    .bg-gray-500{ background-color: var(--pantone-dark-green-500) !important; }

    .text-gray-200, .text-gray-300{ color: var(--pantone-ink) !important; }
    .text-gray-400, .text-gray-500{ color: var(--pantone-ink-muted) !important; }

    .border-gray-800{ border-color: var(--pantone-border) !important; }
    .border-gray-700{ border-color: var(--pantone-border) !important; }

    /* å¡ç‰‡é™°å½±èˆ‡æŒ‰éˆ•äº’å‹•å¾®èª¿ï¼Œè®“æ·±ç¶ æ›´æœ‰å±¤æ¬¡ */
    .shadow, .shadow-xl, .shadow-inner{ box-shadow: 0 6px 18px rgba(0,0,0,.35) !important; }
    .hover\:bg-gray-700:hover{ filter: brightness(1.03) saturate(1.02); }
    .hover\:bg-gray-600:hover{ filter: brightness(1.05) saturate(1.03); }

    /* kbd å¤–è§€å°æ‡‰ç¶ éš */
    .kbd{ border-color: var(--pantone-border); color: var(--pantone-ink-muted); }
      /* æ§åˆ¶å€å¡Šï¼ˆæœ€ä¸‹æ–¹ï¼‰åŠ æ·±ç‚ºæœ€æ·±åº•è‰²ï¼›æŒ‰éˆ•èˆ‡å„²å­˜åˆ—åšå‡ºéšå±¤å°æ¯” */
    #controls-section{ background-color: var(--pantone-dark-green) !important; border: 1px solid var(--pantone-border); }
    #controls-section .action-btn{ background-color: var(--pantone-dark-green-800) !important; border-color: var(--pantone-border) !important; font-weight: 600; }
    /* æ¸…ç©ºäºŒæ®µå¼ç¢ºèªçš„è­¦ç¤ºç‹€æ…‹ */
    #controls-section .danger-btn{ background-color: var(--pantone-dark-green-900) !important; outline: 2px solid rgba(220,80,80,.6); }
    #controls-section .action-btn:hover{ filter: brightness(1.06) saturate(1.04); }
    /* å„²å­˜æŒ‰éˆ•çš„å·²å„²å­˜ç‹€æ…‹ï¼šç¶­æŒ ğŸ’¾ åœ–ç¤ºï¼Œä½†ä»¥è¦–è¦ºæç¤ºå€åˆ† */
    #btn-save.is-saved{ box-shadow: 0 0 0 2px rgba(255,255,255,.08) inset, 0 0 0 2px rgba(120,200,160,.35); }
    /* è­¦ç¤ºå‹•ç•«ï¼šäºŒæ®µå¼ç¢ºèªæ™‚æ˜é¡¯æç¤º */
    @keyframes shakeX { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px);} 30%, 50%, 70% { transform: translateX(-4px);} 40%, 60% { transform: translateX(4px);} }
    .danger-btn{ background-color: var(--pantone-dark-green-900) !important; outline: 2px solid rgba(220,80,80,.6); animation: shakeX 320ms ease-in-out; }
      /* ç¬¬ä¸€å€ï¼šè¼‰å…¥èˆ‡é—œéµå­—è¼¸å…¥æ›´æ·±è‰²ï¼Œå’Œå€å¡ŠèƒŒæ™¯åšå‡ºå€éš” */
    .deep-ctrl{ background-color: var(--pantone-dark-green-950) !important; border-color: var(--pantone-border) !important; }
    .deep-ctrl::placeholder{ color: var(--pantone-ink-muted); }
    .deep-ctrl-btn{ background-color: var(--pantone-dark-green-950) !important; border: 1px solid var(--pantone-border) !important; font-weight: 600; }
    .deep-ctrl-btn:hover{ filter: brightness(1.06) saturate(1.04); }
      /* èˆ‡ã€Œä¸Šä¸€å¼µã€æŒ‰éˆ•ä¸€è‡´çš„è‰²éšï¼ˆå¯å…±ç”¨æ–¼è¼‰å…¥æŒ‰éˆ•èˆ‡ç¶²å€è¼¸å…¥æ¡†ï¼‰ */
    .action-tone{ background-color: var(--pantone-dark-green-800) !important; border: 1px solid var(--pantone-border) !important; }
    .action-tone:hover{ filter: brightness(1.06) saturate(1.04); }
      /* åœ–ç¤ºæŒ‰éˆ•ï¼ˆç·šæ¢ã€ç„¡å¡«è‰²ï¼‰ */
    .icon-btn svg{ width: 20px; height: 20px; color: var(--pantone-ink-muted); }
    #btn-save.is-saved svg{ color: var(--pantone-ink); }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <header class="mb-6">
      <h1 class="text-2xl font-bold tracking-wide text-gray-300 text-center w-full font-sarabun">à¸—à¸³à¹„à¸”à¹‰à¸”à¸µà¹à¸¥à¹‰à¸§</h1>
      <p class="mt-2 text-sm text-gray-400 text-center w-full font-sarabun">à¹€à¸à¹ˆà¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°</p>
    </header>

    <!-- è¨­å®šåˆ—ï¼ˆç„¡æ¸¬é©—æ¨¡å¼ï¼‰ -->
    <section class="bg-gray-900 rounded-xl p-5 mb-8 grid md:grid-cols-3 gap-4">
      <div class="space-y-2">
        <label class="block text-sm">ä¾†æºç¶²å€</label>
        <input id="source-url" class="w-full action-tone rounded-lg px-3 py-2" placeholder="Google Sheet ç™¼ä½ˆ CSV æˆ– pubhtml" />
        <button id="btn-load" class="w-full action-tone rounded-lg py-2 font-semibold">è¼‰å…¥</button>
        <p id="load-msg" class="text-xs text-gray-400"></p>
      </div>

      <div class="space-y-2">
        <label class="block text-sm">é¡¯ç¤ºé¸é …</label>
        <label class="inline-flex items-center gap-2 text-sm"><input id="shuffle" type="checkbox" class="accent-gray-400">éš¨æ©ŸæŠ½é¡Œ</label>
        <label class="inline-flex items-center gap-2 text-sm"><input id="tts" type="checkbox" class="accent-gray-400">ç¿»é¢æ™‚è‡ªå‹•ç™¼éŸ³</label>
      </div>

      <div class="space-y-2">
        <label class="block text-sm">éæ¿¾</label>
        <input id="search" class="w-full action-tone rounded-lg px-3 py-2" placeholder="é—œéµå­—éæ¿¾ï¼ˆä¸­/æ³°/æ‹¼éŸ³ï¼‰" />
        <div class="text-xs text-gray-400">å…¨éƒ¨ï¼š<span id="all-count">0</span> å¼µ</div>
      </div>
    </section>

    <!-- ä¸»å€ï¼šå¡ç‰‡ï¼ˆç¨ç«‹ä¸€åˆ—ï¼‰ -->
    <section class="mb-8 relative">
      <!-- å¿«æ·éµæç¤ºï¼šæ”¾åœ¨å¡ç‰‡å¤–å´å³ä¸Šæ–¹ï¼Œé¿å…è¢«å¡ç‰‡é®æ“‹ -->
      <div class="bg-gray-900 rounded-xl p-5 relative">
        <!-- å¿«æ·éµæç¤ºï¼šå¡ç‰‡å€å¡Šå…§ï¼ˆéå¡ç‰‡å…§ï¼‰ï¼Œç½®æ–¼å¡ç‰‡ä¸Šæ–¹ï¼Œèˆ‡å¡ç‰‡é–“éš”ä¸€è¡Œä¸¦é å³å°é½Š -->
        <div class="w-full text-right text-xs text-gray-400 leading-tight mb-3">
          å¿«æ·éµï¼š<span class="kbd">ç©ºç™½éµ</span>ç¿»é¢ã€<span class="kbd">J</span>/<span class="kbd">K</span> ä¸Šä¸‹ã€<span class="kbd">R</span> éš¨æ©Ÿã€<span class="kbd">G</span> ç™¼éŸ³ã€<span class="kbd">S</span> å„²å­˜/å–æ¶ˆ
        </div>
        <div class="h-72 card-scene">
          <div id="card" class="card rounded-xl bg-gray-800 border border-gray-900 cursor-pointer">
            <div class="card-face p-6">
              <p id="front-big" class="text-3xl text-center leading-snug"></p>
            </div>
            <div class="card-face card-face-back p-6">
              <div class="w-full space-y-2 text-center">
                <p id="back-main-th-sara" class="font-sarabun text-3xl"></p>
                <p id="back-main-th-noto" class="font-noto-thai text-3xl"></p>
                <p id="back-pinyin" class="text-gray-400"></p>
                <p id="back-zh" class="text-gray-300"></p>
              </div>
              <div class="absolute top-3 left-3"><button id="btn-save" title="å„²å­˜/å–æ¶ˆå„²å­˜" class="w-9 h-9 rounded-full bg-gray-800 grid place-items-center hover:bg-gray-700 icon-btn" aria-label="å„²å­˜/å–æ¶ˆå„²å­˜">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M5 3h11l3 3v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/>
    <path d="M7 3v6h10"/>
    <rect x="7" y="13" width="10" height="6" rx="1"/>
  </svg>
</button></div>
              <div class="absolute top-3 right-3"><button id="btn-speak" title="æ’­æ”¾ç™¼éŸ³" class="w-9 h-9 rounded-full bg-gray-800 grid place-items-center hover:bg-gray-700 icon-btn" aria-label="æ’­æ”¾ç™¼éŸ³">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <rect x="9" y="3" width="6" height="10" rx="3"/>
    <path d="M7 12a5 5 0 0 0 10 0"/>
    <path d="M12 17v4"/>
    <path d="M5 21h14"/>
  </svg>
</button></div>
            </div>
          </div>
        </div>
        <div class="mt-4 text-center text-xs text-gray-500">é»æ“Šå¡ç‰‡ç¿»é¢</div>
      </div>
    </section>

    <!-- æ§åˆ¶åˆ—èˆ‡å„²å­˜æ¸…å–®ï¼ˆæ•´å¡Šåœ¨å¡ç‰‡ä¸‹æ–¹ï¼ŒåŒä¸€åˆ—ï¼‰ -->
    <section id="controls-section" class="rounded-xl p-5 space-y-5">
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
        <button id="btn-prev" class="action-btn border rounded-lg py-2">ä¸Šä¸€å¼µ</button>
        <button id="btn-random" class="action-btn border rounded-lg py-2">éš¨æ©ŸæŠ½</button>
        <button id="btn-next" class="action-btn border rounded-lg py-2">ä¸‹ä¸€å¼µ</button>
        <button id="btn-export-csv" class="action-btn border rounded-lg py-2 text-sm">åŒ¯å‡ºCSV</button>
      </div>
      <div id="download-holder" class="text-xs text-gray-400"></div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-gray-300">å·²å„²å­˜çš„å¡ç‰‡</h2>
          <div class="flex items-center gap-3">
            <div class="text-xs text-gray-400">å…± <span id="saved-count">0</span> å¼µ</div>
            <button id="btn-clear-saved" class="action-btn border rounded-lg py-1.5 px-3 text-xs">å…¨éƒ¨æ¸…ç©º</button>
          </div>
        </div>
        <div id="saved-list" class="max-h-64 overflow-y-auto space-y-3"></div>
      </div>
    </section>
  </div>

  <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-gray-200 px-4 py-2 rounded-lg opacity-0 pointer-events-none transition"></div>

  <script>
    // ======== è³‡æ–™èˆ‡ç‹€æ…‹ ========
    const LS_SAVED_KEY = 'thaiFlashcards.saved.v1';

    let deck = []; // {id, zh, th, py}
    let filteredIdx = []; // ç¯©é¸å¾Œçš„ç´¢å¼•
    let cursor = 0; // ç›®å‰æ–¼ filteredIdx çš„ä½ç½®
    let saved = loadJSON(LS_SAVED_KEY, []); // [{id, zh, th, py}]

    const $ = (sel) => document.querySelector(sel);
    const toast = (msg) => { const el = document.getElementById('toast'); el.textContent = msg; el.classList.remove('opacity-0'); el.classList.add('opacity-100'); setTimeout(()=>{ el.classList.add('opacity-0'); }, 1600); };

    // ======== å·¥å…·å‡½å¼ ========
    function loadJSON(key, fallback){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; }catch(e){ return fallback; } }
    function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function uidFor(card){ return btoa(unescape(encodeURIComponent(`${card.th}\u0001${card.zh}`))); }

    function csvAutoFix(url){
      if(url.includes('docs.google.com') && url.includes('/pubhtml')){
        return url.replace('/pubhtml', '/pub?output=csv');
      }
      return url;
    }

    async function fetchCSV(url){
      const fixed = csvAutoFix(url);
      const target = fixed.includes('docs.google.com') ? `https://cors.eu.org/${fixed}` : fixed;
      const res = await fetch(target);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }

    function parseCSV(text){
      const rows = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(Boolean);
      if(rows.length === 0) return [];
      const dataRows = rows[0].includes('ä¸­æ–‡') || rows[0].includes('æ³°æ–‡') ? rows.slice(1) : rows;
      const out = [];
      for(const row of dataRows){
        const cols = row.match(/([^\",]+|"[^"]*")(,|$)/g)?.map(s=>s.replace(/,$/, '')) || row.split(',');
        const clean = (s)=>{
          if(typeof s !== 'string') return '';
          s = s.trim();
          if(s.startsWith('"') && s.endsWith('"')) s = s.slice(1,-1).replace(/""/g,'"');
          return s;
        };
        const zh = clean(cols[0]||'');
        const th = clean(cols[1]||'');
        const py = clean(cols[2]||'');
        if(zh && th){ out.push({ zh, th, py }); }
      }
      return out;
    }

    function rebuildDeck(cards){
      deck = cards.map(c=>({ id: uidFor(c), ...c }));
      applyFilter();
      updateCounts();
      renderCard();
    }

    function current(){ return deck[ filteredIdx[cursor] ] || null; }

    // ======== UI æ›´æ–° ========
    function setCardFront(card){ $('#front-big').textContent = card.zh; }
    function setCardBack(card){
      $('#back-main-th-sara').textContent = card.th;
      $('#back-main-th-noto').textContent = card.th;
      $('#back-pinyin').textContent = card.py || '';
      $('#back-zh').textContent = card.zh;
    }

    function renderCard(){
      const c = current();
      if(!c){ $('#front-big').textContent = 'å°šæœªè¼‰å…¥è³‡æ–™'; return; }
      setCardFront(c);
      setCardBack(c);
      $('#card').classList.remove('is-flipped');
      const isSaved = saved.some(s=>s.id === c.id);
      const saveBtn = document.getElementById('btn-save');
      if(isSaved){ saveBtn.classList.add('is-saved'); saveBtn.setAttribute('title','å–æ¶ˆå„²å­˜'); }
      else { saveBtn.classList.remove('is-saved'); saveBtn.setAttribute('title','å„²å­˜/å–æ¶ˆå„²å­˜'); }
    }

    function updateCounts(){ $('#all-count').textContent = deck.length; $('#saved-count').textContent = saved.length; }

    function applyFilter(){
      const q = $('#search').value.trim().toLowerCase();
      const pool = $('#shuffle').checked ? [...deck].sort(()=>Math.random()-0.5) : deck;
      filteredIdx = [];
      pool.forEach((c)=>{
        const hit = !q || c.zh.toLowerCase().includes(q) || c.th.toLowerCase().includes(q) || (c.py||'').toLowerCase().includes(q);
        if(hit){ filteredIdx.push(deck.indexOf(c)); }
      });
      cursor = 0;
    }

    // ======== ç™¼éŸ³ ========
    function speakThai(text){
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'th-TH';
      u.rate = 1.15;
      window.speechSynthesis.speak(u);
    }

    // ======== å„²å­˜æ¸…å–® ========
    function toggleSave(card){
      const i = saved.findIndex(s=>s.id===card.id);
      if(i>=0){ saved.splice(i,1); toast('å·²å–æ¶ˆå„²å­˜'); }
      else { saved.push(card); toast('å·²å„²å­˜'); }
      saveJSON(LS_SAVED_KEY, saved); renderSaved(); renderCard(); updateCounts();
    }

    function renderSaved(){
      const box = $('#saved-list'); box.innerHTML='';
      if(saved.length===0){ box.innerHTML='<div class="text-sm text-gray-500">å°šæœªå„²å­˜ä»»ä½•å¡ç‰‡</div>'; return; }
      saved.slice().reverse().forEach(c=>{
        const row = document.createElement('div');
        row.className = 'p-4 bg-gray-900 rounded-lg flex items-center justify-between';
        row.innerHTML = `<div><div class="font-semibold text-gray-300">${c.zh}</div><div class="font-sarabun text-gray-300 text-sm">${c.th}</div><div class="text-xs text-gray-500">${c.py||''}</div></div><div class="flex gap-2"><button class="w-9 h-9 grid place-items-center bg-gray-800 rounded icon-btn" data-act="speak" title="æ’­æ”¾ç™¼éŸ³" aria-label="æ’­æ”¾ç™¼éŸ³"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="9" y="3" width="6" height="10" rx="3"/><path d="M7 12a5 5 0 0 0 10 0"/><path d="M12 17v4"/><path d="M5 21h14"/></svg></button><button class="w-9 h-9 grid place-items-center bg-gray-700 rounded icon-btn" data-act="del" title="ç§»é™¤" aria-label="ç§»é™¤"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg></button></div>`;
        row.querySelector('[data-act="speak"]').onclick = ()=>speakThai(c.th);
        row.querySelector('[data-act="del"]').onclick = ()=>{ saved = saved.filter(x=>x.id!==c.id); saveJSON(LS_SAVED_KEY, saved); renderSaved(); updateCounts(); };
        box.appendChild(row);
      });
    }

    let __clearArmTimer = null; let __clearArmed = false;
    function clearSavedAll(){
      const btn = document.getElementById('btn-clear-saved');
      if(!btn){ console.warn('æ‰¾ä¸åˆ°æ¸…ç©ºæŒ‰éˆ•å…ƒç´ '); return; }
      if(saved.length===0){ toast('æ²’æœ‰å¯æ¸…ç©ºçš„å¡ç‰‡'); return; }

      // çµ±ä¸€æ¡äºŒæ®µå¼ç¢ºèªï¼Œé¿å… sandbox é˜»æ“‹ confirm
      if(!__clearArmed){
        __clearArmed = true;
        btn.textContent = 'ç¢ºå®šæ¸…ç©ºï¼Ÿ';
        btn.classList.add('danger-btn');
        if(__clearArmTimer) clearTimeout(__clearArmTimer);
        __clearArmTimer = setTimeout(()=>{
          __clearArmed = false;
          btn.textContent = 'å…¨éƒ¨æ¸…ç©º';
          btn.classList.remove('danger-btn');
        }, 3500);
        toast('å†æ¬¡é»æ“Šä»¥ç¢ºèªæ¸…ç©º');
        return;
      }

      // ç¬¬äºŒæ¬¡é»æ“Šï¼ŒåŸ·è¡Œæ¸…ç©º
      if(__clearArmTimer) clearTimeout(__clearArmTimer);
      __clearArmed = false;
      btn.textContent = 'å…¨éƒ¨æ¸…ç©º';
      btn.classList.remove('danger-btn');

      saved = [];
      saveJSON(LS_SAVED_KEY, saved);
      renderSaved();
      updateCounts();
      toast('å·²æ¸…ç©ºæ‰€æœ‰å·²å„²å­˜å¡ç‰‡');
    }

    function buildSavedCSVString(list){
      let csv = '\uFEFFæ³°æ–‡,æ‹¼éŸ³,ä¸­æ–‡\r\n';
      for(const c of list){
        const esc = s=>`"${(s||'').replace(/"/g,'""')}"`;
        csv += `${esc(c.th)},${esc(c.py)},${esc(c.zh)}\r\n`;
      }
      return csv;
    }

    // æ›´ç©©å¥çš„åŒ¯å‡ºæµç¨‹ï¼ˆå« iOS Safari å¾Œå‚™æ–¹æ¡ˆï¼‰
    async function exportSavedCSV(){
      if(saved.length===0){ toast('æ²’æœ‰å¯åŒ¯å‡ºçš„å·²å­˜å¡ç‰‡'); return; }
      const csv = buildSavedCSVString(saved);
      const filename = 'thai_saved_cards.csv';
      const holder = document.getElementById('download-holder');
      holder.innerHTML = '';

      // 1) å„ªå…ˆä½¿ç”¨ File System Access APIï¼ˆæœ€å¯é çš„ä½¿ç”¨è€…æˆæ¬Šä¸‹è¼‰ï¼‰
      if(window.showSaveFilePicker){
        try{
          const handle = await window.showSaveFilePicker({
            suggestedName: filename,
            types: [{ description: 'CSV', accept: { 'text/csv': ['.csv'] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
          await writable.close();
          toast('CSV å·²å„²å­˜');
          return;
        }catch(e){
          // ä½¿ç”¨è€…å–æ¶ˆæˆ– API å¤±æ•—ï¼Œæ”¹ç”¨å…¶ä»–ç­–ç•¥
          console.warn('showSaveFilePicker å¤±æ•—æˆ–ä½¿ç”¨è€…å–æ¶ˆï¼š', e);
        }
      }

      // 2) ç‰©ä»¶ç¶²å€ + éš±å½¢ <a download>
      try{
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.rel = 'noopener'; a.style.display='none';
        document.body.appendChild(a);
        a.dispatchEvent(new MouseEvent('click', {bubbles:true, cancelable:true, view:window}));
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        // è¨±å¤šç’°å¢ƒä¸æœƒé¡¯ç¤ºç³»çµ±æç¤ºï¼Œé€™è£¡æä¾›æ‰‹å‹•é€£çµå‚™æ´
        holder.innerHTML = `è‹¥æœªè‡ªå‹•ä¸‹è¼‰ï¼Œè«‹é»æ­¤æ‰‹å‹•ä¸‹è¼‰ï¼š<a class="underline" href="${url}" download="${filename}">thai_saved_cards.csv</a>`;
        toast('å·²è§¸ç™¼ä¸‹è¼‰/æä¾›æ‰‹å‹•é€£çµ');
        return;
      }catch(err){
        console.warn('Object URL ä¸‹è¼‰å¤±æ•—ï¼š', err);
      }

      // 3) è³‡æ–™ URI æ–°åˆ†é ï¼ˆiOS ç­‰ç’°å¢ƒï¼‰
      try{
        const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        const w = window.open();
        if(w) { w.document.location = dataUri; toast('å·²åœ¨æ–°åˆ†é é–‹å•Ÿ CSV'); return; }
        // 4) æœ€å¾Œå‚™æ´ï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿
        await navigator.clipboard.writeText(csv);
        holder.textContent = 'å·²å°‡ CSV è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹è‡ªè¡Œè²¼åˆ°æ–‡å­—æª”å­˜æˆ .csv';
        toast('å·²è¤‡è£½ CSV æ–‡å­—');
      }catch(e){
        holder.textContent = 'ç„¡æ³•è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—æˆ–æ”¹ç”¨æ¡Œé¢ç€è¦½å™¨ã€‚';
        console.error('æ‰€æœ‰åŒ¯å‡ºç­–ç•¥çš†å¤±æ•—ï¼š', e);
      }
    }

    // ======== å°è¦½èˆ‡äº’å‹• ========
    function prevCard(){ if(filteredIdx.length===0) return; cursor = (cursor - 1 + filteredIdx.length) % filteredIdx.length; renderCard(); }
    function nextCard(){ if(filteredIdx.length===0) return; cursor = (cursor + 1) % filteredIdx.length; renderCard(); }
    function randomCard(){ if(filteredIdx.length<=1) return; let ni; do{ ni = Math.floor(Math.random()*filteredIdx.length); }while(ni===cursor); cursor = ni; renderCard(); }

    // ç¶å®šäº‹ä»¶
    $('#btn-load').onclick = async ()=>{
      const url = $('#source-url').value.trim();
      if(!url){ $('#load-msg').textContent = 'è«‹è²¼ä¸Šç¶²å€'; return; }
      $('#load-msg').textContent = 'è¼‰å…¥ä¸­â€¦';
      try{
        const csv = await fetchCSV(url);
        const rows = parseCSV(csv);
        rebuildDeck(rows);
        $('#load-msg').textContent = `æˆåŠŸè¼‰å…¥ ${rows.length} ç­†`;
        renderSaved();
      }catch(e){ $('#load-msg').textContent = 'è¼‰å…¥å¤±æ•—ï¼š'+e.message; }
    };

    $('#shuffle').onchange = ()=>{ applyFilter(); renderCard(); };
    $('#search').oninput = ()=>{ applyFilter(); renderCard(); };
    document.getElementById('btn-prev').onclick = prevCard;
    document.getElementById('btn-next').onclick = nextCard;
    document.getElementById('btn-random').onclick = randomCard;
    document.getElementById('btn-save').onclick = ()=>{ const c=current(); if(c) toggleSave(c); };
    document.getElementById('btn-speak').onclick = ()=>{ const c=current(); if(c) speakThai(c.th); };
    document.getElementById('btn-export-csv').onclick = exportSavedCSV;
    // ç¶å®šæ–¹å¼æ”¹ç‚ºäº‹ä»¶å§”æ´¾ï¼Œé¿å…ä»»ä½•æœªä¾† DOM æ›´æ–°å°è‡´ç¶å®šå¤±æ•ˆ
    document.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'btn-clear-saved'){ clearSavedAll(); } });

    document.getElementById('card').onclick = (ev)=>{
      if(ev.target.closest('#btn-save') || ev.target.closest('#btn-speak')) return;
      const el = document.getElementById('card');
      el.classList.toggle('is-flipped');
      if(el.classList.contains('is-flipped') && document.getElementById('tts').checked){ const c=current(); if(c) speakThai(c.th); }
    };

    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key==='j' || e.key==='ArrowLeft') prevCard();
      else if(e.key==='k' || e.key==='ArrowRight') nextCard();
      else if(e.key===' '){ e.preventDefault(); const el=document.getElementById('card'); el.classList.toggle('is-flipped'); if(el.classList.contains('is-flipped') && document.getElementById('tts').checked){ const c=current(); if(c) speakThai(c.th); } }
      else if(e.key.toLowerCase()==='r') randomCard();
      else if(e.key.toLowerCase()==='g'){ const c=current(); if(c) speakThai(c.th); }
      else if(e.key.toLowerCase()==='s'){ const c=current(); if(c) toggleSave(c); }
    });

    // ======== æ¸¬è©¦ï¼ˆè‡ªå‹•åŸ·è¡Œï¼‰ ========
    function runTests(){
      console.group('%cTest: parseCSV èˆ‡ CSV åŒ¯å‡º','color:#6ee7b7');
      const t1 = 'ä¸­æ–‡,æ³°æ–‡,æ‹¼éŸ³\næ—©å®‰,à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²,sawatdii';
      const r1 = parseCSV(t1); console.assert(r1.length===1 && r1[0].zh==='æ—©å®‰' && r1[0].th==='à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²','t1 å¤±æ•—');
      const t2 = 'ä¸­æ–‡,æ³°æ–‡,æ‹¼éŸ³\r\n"A,B","à¸„à¸­à¸¡à¸¡à¸²,à¸—à¸”à¸ªà¸­à¸š","ka,ra"\r\n';
      const r2 = parseCSV(t2); console.assert(r2.length===1 && r2[0].zh==='A,B' && r2[0].th==='à¸„à¸­à¸¡à¸¡à¸²,à¸—à¸”à¸ªà¸­à¸š','t2 å¤±æ•—');
      const t3 = '\uFEFFä¸­æ–‡,æ³°æ–‡,æ‹¼éŸ³\nè¬è¬,à¸‚à¸­à¸šà¸„à¸¸à¸“,khop khun';
      const r3 = parseCSV(t3); console.assert(r3.length===1 && r3[0].zh==='è¬è¬' && r3[0].th==='à¸‚à¸­à¸šà¸„à¸¸à¸“','t3 å¤±æ•—');
      const t4 = 'æ™šå®‰,à¸£à¸²à¸•à¸£à¸µà¸ªà¸§à¸±à¸ªà¸”à¸´à¹Œ,raat-rii';
      const r4 = parseCSV(t4); console.assert(r4.length===1 && r4[0].zh==='æ™šå®‰','t4 å¤±æ•—');
      const csvStr = buildSavedCSVString([{zh:'æ—©å®‰', th:'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²', py:'sawatdii'}]);
      console.assert(csvStr.startsWith('\uFEFF'),'CSV ç„¡ BOM');
      console.assert(csvStr.includes('æ³°æ–‡,æ‹¼éŸ³,ä¸­æ–‡'),'CSV æ¨™é¡ŒéŒ¯èª¤');
      console.assert(csvStr.trim().endsWith('"à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²","sawatdii","æ—©å®‰"'),'CSV å…§å®¹éŒ¯èª¤');
      console.groupEnd();
    }

    (function init(){
      try{ runTests(); }catch(e){ console.error('æ¸¬è©¦éŒ¯èª¤ï¼š', e); }
      renderSaved(); updateCounts();
      const demo = [
        { zh:'æ—©å®‰', th:'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²', py:'sawatdii ton chao' },
        { zh:'æ™šå®‰', th:'à¸£à¸²à¸•à¸£à¸µà¸ªà¸§à¸±à¸ªà¸”à¸´à¹Œ', py:'raat-rii sa-wat' },
        { zh:'è¬è¬', th:'à¸‚à¸­à¸šà¸„à¸¸à¸“', py:'khop khun' },
      ];
      rebuildDeck(demo);
    })();
  </script>
</body>
</html>
